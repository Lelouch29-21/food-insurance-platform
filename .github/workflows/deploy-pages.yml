name: Deploy GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Food App deps
        working-directory: food-app-frontend
        run: npm ci

      - name: Build Food App
        working-directory: food-app-frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          BASE_PATH: /food-insurance-platform/food-app-frontend/
          VITE_USE_HASH_ROUTER: 'true'
        run: npm run build

      - name: Install Insurance App deps
        working-directory: insurance-app-frontend
        run: npm ci

      - name: Build Insurance App
        working-directory: insurance-app-frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          BASE_PATH: /food-insurance-platform/insurance-app-frontend/
          VITE_USE_HASH_ROUTER: 'true'
        run: npm run build

      - name: Assemble Pages artifact
        run: |
          mkdir -p _site/food-app-frontend _site/insurance-app-frontend
          cp -R food-app-frontend/dist/* _site/food-app-frontend/
          cp -R insurance-app-frontend/dist/* _site/insurance-app-frontend/
          cp food-app-frontend/dist/index.html _site/food-app-frontend/404.html
          cp insurance-app-frontend/dist/index.html _site/insurance-app-frontend/404.html
          cat > _site/index.html << 'HTML'
          <!doctype html>
          <html lang="en">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Food + Insurance Platform</title>
              <style>
                @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Playfair+Display:wght@700&display=swap');
                * { box-sizing: border-box; }
                body {
                  margin: 0;
                  min-height: 100vh;
                  font-family: 'Outfit', sans-serif;
                  color: #0f172a;
                  background: radial-gradient(circle at 15% 20%, #fde68a 0, transparent 34%),
                              radial-gradient(circle at 90% 0%, #bfdbfe 0, transparent 30%),
                              linear-gradient(180deg, #fff7ed 0%, #eff6ff 100%);
                }
                .wrap {
                  max-width: 960px;
                  margin: 0 auto;
                  padding: 56px 24px;
                }
                .title {
                  font-family: 'Playfair Display', serif;
                  font-size: clamp(2.2rem, 5vw, 3.4rem);
                  margin: 0;
                }
                .subtitle {
                  margin-top: 12px;
                  color: #334155;
                  max-width: 60ch;
                  line-height: 1.6;
                }
                .grid {
                  margin-top: 28px;
                  display: grid;
                  gap: 16px;
                  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
                }
                .card {
                  border-radius: 20px;
                  padding: 20px;
                  background: rgba(255, 255, 255, 0.8);
                  border: 1px solid rgba(255, 255, 255, 0.9);
                  box-shadow: 0 18px 40px -26px rgba(15, 23, 42, 0.4);
                  backdrop-filter: blur(6px);
                }
                .tag {
                  display: inline-block;
                  padding: 4px 10px;
                  border-radius: 999px;
                  font-size: 12px;
                  font-weight: 700;
                  letter-spacing: .06em;
                  text-transform: uppercase;
                }
                .food { background: #ffedd5; color: #c2410c; }
                .ins { background: #dbeafe; color: #1d4ed8; }
                .btn {
                  display: inline-block;
                  margin-top: 14px;
                  text-decoration: none;
                  border-radius: 12px;
                  padding: 10px 14px;
                  font-weight: 700;
                  color: white;
                }
                .btn-food { background: linear-gradient(90deg, #f97316, #ef4444); }
                .btn-ins { background: linear-gradient(90deg, #2563eb, #4f46e5); }
              </style>
            </head>
            <body>
              <main class="wrap">
                <h1 class="title">Food + Insurance Platform</h1>
                <p class="subtitle">
                  Two integrated applications: one for food ordering and one for insurance analytics.
                  Navigate to each experience below.
                </p>
                <section class="grid">
                  <article class="card">
                    <span class="tag food">Food App</span>
                    <h2>FlavorFinance</h2>
                    <p>Browse menu items, track health score impact, and checkout with dynamic interest updates.</p>
                    <a class="btn btn-food" href="./food-app-frontend/">Open Food App</a>
                  </article>
                  <article class="card">
                    <span class="tag ins">Insurance App</span>
                    <h2>PolicyPulse</h2>
                    <p>View ABSLI plans, run premium projections, and monitor adjustment logs in admin mode.</p>
                    <a class="btn btn-ins" href="./insurance-app-frontend/">Open Insurance App</a>
                  </article>
                </section>
              </main>
            </body>
          </html>
          HTML

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
